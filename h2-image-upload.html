<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="./behaviors/base-behavior.html">
<link rel="import" href="./h2-label.html">
<link rel="import" href="./h2-button.html">

<!--

```html

<h2-image-upload label="上河图" value="{{file}}"></h2-image-upload>

<h2-image-upload size-limit="1.4M" value="{{file}}"></h2-image-upload>

```
-->

<dom-module id="h2-image-upload">
  <template>
    <style>
      :host {
        display: inline-block;
        font-size: 12px;
      }

      h2-label {
        --h2-label: {
          @apply --h2-image-upload-label;
        }
      }

      #main-container {
        display: flex;
        height: inherit;
      }

      #inner-container {
        display: flex;
        flex-flow: column nowrap;
        border: 1px dashed #ccc;
        font-size: inherit;
        width: var(--h2-image-upload-width, 140px);
        height: var(--h2-image-upload-height, 180px);
        background: #f0f0f0;
        position: relative;
      }

      #img__container {
        flex: 1;
        cursor: zoom-in;
        display: flex;
      }

      .toolbar {
        display: flex;
        background: rgba(79, 79, 79, 0.33);
        height: 36px;
        justify-content: space-evenly;
        align-items: center;
        padding: 0 2px;
      }

      .toolbar h2-button {
        height: 26px;
        width: 42px;
        --h2-button: {
          background-color: #5cb85c;
          @apply --h2-image-upload-buttons;
        };
      }

      #cancel-btn {
        --h2-button: {
          background-color: #d9534f;
        }
      }

      #viewer-dialog {
        display: flex;
        overflow: hidden;
        width: 90%;
        height: 90%;
        background: transparent;
        padding: 0;
      }

      #viewer-img {
        cursor: zoom-out;
        padding: 0;
        margin: auto;
        width: 100%;
        height: 100%;
      }

      #file-chooser {
        display: none;
      }

      #paste-panel {
        flex: 1;

        outline: 1px dashed #aeaeae;
        outline-offset: -10px;
        text-align: center;
        padding: 20px;

        display: flex;
        justify-content: center;
        align-items: center;
      }

      #paste-panel[hidden] {
        display: none;
      }

      :host([data-has-src]) #paste-panel,
      :host(:not([data-has-src])) #cancel-btn {
        display: none;
      }

      :host(:not([data-has-src])) #img__container {
        cursor: default;
      }

      :host([readonly]) .mask,
      :host([disabled]) .mask {
        position: absolute;
        top: -1px;
        bottom: -1px;
        right: -1px;
        left: -1px;
        background-color: rgba(255, 255, 255, 0.5);
        z-index: 10;
      }

    </style>

    <div id="main-container">
      <h2-label value="[[label]]"></h2-label>
      <div id="inner-container">
        <div id="img__container" on-click="viewZoom">
          <div id="paste-panel">拖拽或者粘贴图片到这里</div>
        </div>

        <div class="toolbar">
          <h2-button title="点击选择文件" on-click="triggleChooseFile">选择</h2-button>
          <h2-button id="cancel-btn" on-click="cancelSelection">取消</h2-button>
          <input type="file" on-change="chooseFile" id="file-chooser"
                 accept$="[[accept]]"/>
        </div>
        <div class="mask"></div>
      </div>
    </div>
    <paper-dialog id="viewer-dialog"
                  on-click="closeDialog"
                  with-backdrop>
      <div id="viewer-img"></div>
    </paper-dialog>

  </template>
  <script>
    /**
     * `h2-image-upload`
     *
     * @customElement
     * @polymer
     * @demo demo/h2-image-upload/index.html
     */
    class H2ImageUpload extends Polymer.mixinBehaviors([BaseBehavior], Polymer.Element) {
      static get properties() {
        return {
          /**
           *
           */
          src: {
            type: String
          },
          /**
           *
           */
          value: {
            type: Object,
            notify: true
          },

          readonly: {
            type: Boolean
          },

          label: {
            type: String
          },

          required: {
            type: Boolean
          },

          /**
           * The max size/length of image allowed to upload.
           * Support pattern:  /^((?:\d*\.)?\d+)([GgMmKk][Bb]?$)/
           * i.e 1M, 1Mb, 2Kb
           * @type string
           */
          sizeLimit: {
            type: String
          },

          __byteSize: {
            type: Number,
            computed: '__parseSizeLimit(sizeLimit)'
          },

          /**
           * Bound to input's `accept` attribute.
           */
          accept: {
            type: String,
            value: 'image/gif, image/jpeg, image/png, image/svg+xml'
          }
        };
      }

      static get is() {
        return "h2-image-upload";
      }

      static get observers() {
        return [
          '__srcChanged(src)'
        ]
      }

      connectedCallback() {
        super.connectedCallback();
        const ele = this.$['paste-panel'];

        const dragHandler = (e) => {
          e.preventDefault();
          e.stopPropagation();

          if (this.readonly) return;
          if (e.type === "drop") {
            this.__readDataTransfer(e.dataTransfer);
          } else if (e.type === 'paste') {
            this.__readDataTransfer(e.clipboardData);
          }
        };

        ele.addEventListener("dragenter", dragHandler, false);
        ele.addEventListener("dragleave", dragHandler, false);
        ele.addEventListener('dragover', dragHandler, false);
        ele.addEventListener('drop', dragHandler, false);
        ele.addEventListener('paste', dragHandler, false);
      }


      __srcChanged(src) {
        const style = this.$["img__container"].style;
        const viewerStyle = this.$['viewer-img'].style;

        if (src) {
          this.setAttribute('data-has-src', '');

          style.background = `url(${src}) no-repeat center`;
          style.backgroundSize = "contain";
          viewerStyle.background = `url(${src}) no-repeat center`;
          viewerStyle.backgroundSize = "contain";

        } else {
          this.removeAttribute('data-has-src');

          style.background = "none";
          viewerStyle.background = "none";
        }
      }

      __parseSizeLimit(sizeLimit) {
        const reg = /^((?:\d*\.)?\d+)([GgMmKk][Bb]?$)/g;

        if (!reg.test(sizeLimit)) return 0;

        const bits = sizeLimit.replace(reg, (match, size, unit) => {
          switch (unit.toUpperCase()) {
            case 'GB':
            case 'G':
              return size * Math.pow(1024, 3);
            case 'MB':
            case 'M':
              return size * Math.pow(1024, 2);
            case 'KB':
            case 'K':
              return size * 1024;
          }
        });

        return bits | 0;
      }

      triggleChooseFile() {
        const fileChooser = this.$['file-chooser'];
        fileChooser && fileChooser.click();
      }

      chooseFile(e) {
        const file = e.target.files[0];
        file && this.__loadFileData(file);
      }

      __readDataTransfer(dataTransfer) {
        const source = [].find.call(dataTransfer.items, item => item.kind === 'file' && item.type.startsWith("image"));
        source && this.__loadFileData(source.getAsFile());
      }

      __loadFileData(blob) {
        if (this.__byteSize > 0 && blob.size > this.__byteSize) {
          alert(`上传图片不能超过${this.sizeLimit}`);
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          this.src = e.target.result;
          this.value = blob;
        };
        reader.readAsDataURL(blob);
      }

      /**
       * 取消/删除 已有图片
       * */
      cancelSelection() {
        this.src = null;
        this.value = null;
        this.$['file-chooser'].value = '';
      }

      /**
       * 查看大图
       */
      viewZoom() {
        if (this.src) {
          this.$['viewer-dialog'].open();
        }
      }

      closeDialog() {
        this.$['viewer-dialog'].close();
      }

      validate() {
        return this.required ? !!this.value : true;
      }
    }

    window.customElements.define(H2ImageUpload.is, H2ImageUpload);
  </script>
</dom-module>
