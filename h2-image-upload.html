<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="./behaviors/base-behavior.html">
<link rel="import" href="./h2-label.html">
<link rel="import" href="./h2-button.html">

<!--

```javascript

<h2-image-upload></h2-image-upload>
```
-->

<dom-module id="h2-image-upload">
  <template>
    <style>
      :host {
        display: inline-block;
        font-size: 12px;
      }


      h2-label {
        --h2-label: {
          @apply --h2-image-upload-label;
        }
      }

      #main-container {
        display: flex;
        height: inherit;
      }

      #inner-container {
        display: flex;
        flex-flow: column nowrap;
        border: 1px dashed #ccc;
        font-size: inherit;
        width: var(--h2-image-upload-width, 150px);
        height: var(--h2-image-upload-height, 190px);
        background: #f0f0f0;
      }

      #img__container {
        flex: 1;
        cursor: zoom-in;
        display: flex;
      }

      .toolbar {
        display: flex;
        background: rgba(79, 79, 79, 0.33);
        border-top: 1px solid #ccc;
        height: 40px;
        justify-content: space-evenly;
        align-items: center;
        padding: 0 2px;
      }

      .toolbar h2-button {
        height: 26px;
        width: 42px;
        --h2-button: {
          background-color: var(--h2-image-upload-btn-bg-color, #5cb85c);
        };
      }

      #cancel-btn {
        --h2-button: {
          background-color: #d9534f;
        }
      }

      .img__viewer {
        display: flex;
        overflow: hidden;
      }

      .img__viewer > img {
        cursor: zoom-out;
        margin: 0;
        padding: 0;
      }

      #file-chooser {
        display: none;
      }

      #paste-panel {
        flex: 1;

        outline: 1px dashed #aeaeae;
        outline-offset: -10px;
        text-align: center;
        padding: 20px;

        display: flex;
        justify-content: center;
        align-items: center;
      }

      #paste-panel[hidden] {
        display: none;
      }

      :host([required]) {

      }

      :host([readonly]) {

      }

      :host([data-has-src]) #paste-panel,
      :host(:not([data-has-src])) .btn--common {
        display: none;
      }

      :host(:not([data-has-src])) #img__container {
        cursor: default;
      }

    </style>

    <div id="main-container">
      <h2-label value="[[label]]"></h2-label>
      <div id="inner-container">
        <div id="img__container" on-click="viewZoom">
          <div id="paste-panel">拖拽或者粘贴图片到这里</div>
        </div>

        <div class="toolbar">
          <h2-button title="点击选择文件" on-click="triggleChooseFile">选择</h2-button>
          <h2-button class="btn--common" on-click="viewZoom">查看</h2-button>
          <h2-button class="btn--common" id="cancel-btn" on-click="cancelSelection">取消</h2-button>
          <input type="file" on-change="chooseFile" id="file-chooser"
                 accept$="[[accept]]"/>
        </div>
      </div>
    </div>
    <paper-dialog class="img__viewer"
                  id="dialog"
                  on-click="closeDialog"
                  with-backdrop>
      <img src$="[[src]]"/>
    </paper-dialog>

  </template>
  <script>
    /**
     * `h2-image-upload`
     *
     * @customElement
     * @polymer
     * @demo demo/h2-image-upload/index.html
     */
    class H2ImageUpload extends Polymer.mixinBehaviors([BaseBehavior], Polymer.Element) {
      static get properties() {
        return {
          /**
           *
           */
          src: {
            type: String
          },
          /**
           *
           */
          value: {
            type: Object,
            notify: true
          },

          readonly: {
            type: Boolean
          },

          label: {
            type: String
          },

          required: {
            type: Boolean
          },

          sizeLimit: {
            type: String
          },

          __bitSize: {
            type: Number,
            computed: '__parseSizeLimit(sizeLimit)'
          },

          /**
           * Bound to input's `accept` attribute.
           */
          accept: {
            type: String,
            value: 'image/gif, image/jpeg, image/png, image/svg+xml'
          }
        };
      }

      static get is() {
        return "h2-image-upload";
      }

      static get observers() {
        return [
          '__srcChanged(src)'
        ]
      }

      connectedCallback() {
        super.connectedCallback();
        const ele = this.$['paste-panel'];

        const dragHandler = (e) => {
          e.preventDefault();
          e.stopPropagation();

          if (this.readonly) return;
          if (e.type === "drop") {
            this.__readDataTransfer(e.dataTransfer);
          } else if (e.type === 'paste') {
            this.__readDataTransfer(e.clipboardData);
          }
        };

        ele.addEventListener("dragenter", dragHandler, false);
        ele.addEventListener("dragleave", dragHandler, false);
        ele.addEventListener('dragover', dragHandler, false);
        ele.addEventListener('drop', dragHandler, false);
        ele.addEventListener('paste', dragHandler, false);
      }

      __srcChanged(src) {
        const style = this.$["img__container"].style;

        if (src) {
          this.setAttribute('data-has-src', '');

          style.background = `url(${src}) no-repeat center`;
          style.backgroundSize = "contain";
        } else {
          this.removeAttribute('data-has-src');

          style.background = "none";
        }
      }

      __parseSizeLimit(sizeLimit) {
        const reg = /^((?:\d*\.)?\d+)([GgMmKk][Bb]?$)/g;

        if (!reg.test(sizeLimit)) return 0;

        const bits = sizeLimit.replace(reg, (match, size, unit) => {
          switch (unit.toUpperCase()) {
            case 'GB':
            case 'G':
              return size * Math.pow(1024, 3);
            case 'MB':
            case 'M':
              return size * Math.pow(1024, 2);
            case 'KB':
            case 'K':
              return size * 1024;
          }
        });

        return bits | 0;
      }

      triggleChooseFile() {
        const fileChooser = this.shadowRoot.querySelector('#file-chooser');
        fileChooser && fileChooser.click();
      }

      chooseFile(e) {
        const file = e.target.files[0];
        file && this.__loadFileData(file);
      }

      __readDataTransfer(dataTransfer) {
        const source = [].find.call(dataTransfer.items, item => item.kind === 'file' && item.type.startsWith("image"));
        source && this.__loadFileData(source.getAsFile());
      }

      __loadFileData(blob) {
        if (this.__bitSize > 0 && blob.size > this.__bitSize) {
          alert(`上传图片不能超过${this.sizeLimit}`);
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          this.src = e.target.result;
          this.value = blob;
        };
        reader.readAsDataURL(blob);
      }

      /**
       * 取消/删除 已有图片
       * */
      cancelSelection() {
        this.src = null;
        this.value = null;
        this.shadowRoot.querySelector('#file-chooser').value = '';
      }

      /**
       * 查看大图
       */
      viewZoom() {
        this.src && this.$.dialog.open();
      }

      closeDialog() {
        this.$.dialog.close();
      }

      validate() {
        return this.required ? !!this.value : true;
      }
    }

    window.customElements.define(H2ImageUpload.is, H2ImageUpload);
  </script>
</dom-module>
