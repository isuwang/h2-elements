<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="./h2-label.html">
<link rel="import" href="./h2-fetch.html">
<script type="text/javascript" src="./resource/plugin/dictionary/firstLetterDictionary.js"></script>
<script type="text/javascript" src="./resource/plugin/dictionary/commonDictionary.js"></script>
<script type="text/javascript" src="./resource/plugin/pinyinUtil.js"></script>
<script type="text/javascript" src="./resource/plugin/cacheSearchUtil.js"></script>

<!--

```javascript

<h2-picker></h2-picker>
```
-->

<dom-module id="h2-picker">
  <template>
    <style>
      :host {
        display: flex;
        height: 36px;
        line-height: 36px;
        width: 300px;
        position: relative;
      }

      h2-label {
        @apply --h2-picker-label;
      }

      .input-wrap {
        flex: 1;
        position: relative;
        display: flex;
      }

      .input-container {
        flex: 1;
        display: flex;
      }

      #keywordInput {
        flex: 1;
        min-width: 40px;
        font-size: 14px;
        height: 22px;
        line-height: 22px;
        padding: 0;
        margin: 2px 2px 3px 2px;

        border: none;
        outline: none;
      }

      /*标签容器*/
      .tags-input {
        flex: 1;

        display: flex;
        flex-wrap: wrap;

        background: #FFF;
        padding: 4px;
        overflow-y: auto;

        border: 1px solid #CCC;
        border-radius: 4px;
      }

      .tag {
        color: #666;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;

        margin: 2px 2px 3px 2px;
        padding: 0 4px;
        height: 22px;
        line-height: 22px;
        max-width: 200px;

        display: flex;
        font-size: 14px;
        white-space: nowrap;
        cursor: default;
        @apply --h2-picker-tag;
      }

      .tag-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .tag-deleter {
        margin-left: 6px;
        font-weight: bold;
        text-decoration: inherit;
      }

      .tag-deleter:hover {
        color: #f60;
      }

      #picker-collapse {
        display: flex;
        position: absolute;
        top: 100%;
        width: 100%;
        margin-top: 1px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 99;
        padding: 0;
        background: white;
        color: black;

        visibility: visible;
        opacity: 1;

        -webkit-transition: all 200ms ease-in;
        -moz-transition: all 200ms ease-in;
        -ms-transition: all 200ms ease-in;
        -o-transition: all 200ms ease-in;
        transition: all 200ms ease-in;

        @apply --h2-picker-collapse;
      }

      #picker-collapse[hidden] {
        visibility: hidden;
        height: 0;
        opacity: 0;
      }

      /*显示下拉面板*/
      :host .show {
        opacity: 1;
        visibility: visible;
      }

      .collapse-content__table {
        width: 100%;
        font-size: 12px;
        background-color: #ffffff;
        border-collapse: separate;
        border-spacing: 0;
        text-align: left;
        border-radius: 4px;

        -moz-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
        -webkit-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
      }

      .collapse-table__cell {
        white-space: nowrap;
        padding: 6px 10px;
        line-height: 1.42857143;
        border-bottom: 1px solid #ddd;
      }

      th.collapse-table__cell {
        padding-top: 12px;
        font-size: 1.1em;
      }

      tbody > tr:nth-last-of-type(even) {
        background-color: #efefef;
      }

      tbody > tr:hover {
        background-color: #CAF1FF;
        cursor: pointer;
      }

      tr.candidate-item--focus {
        background: #CAF1FF !important;
      }

      .table-hotkey {
        width: 40px;
      }

      :host([readonly]) .mask,
      :host([disabled]) .mask {
        position: absolute;
        top: -1px;
        bottom: -1px;
        right: -1px;
        left: -1px;
        background-color: rgba(255, 255, 255, 0.5);
        z-index: 10;
      }

      :host([required])::after {
        content: "*";
        color: red;
        position: absolute;
        right: -15px;
        line-height: inherit;
      }
    </style>

    <h2-label value="[[label]]"></h2-label>
    <div class="input-wrap">
      <div class="input-container">

        <div class="tags-input" on-click="__openCollapse">
          <template is="dom-repeat" items="[[ selectedValues ]]">
            <span class="tag">
                <span class="tag-name" title="[[_getTag(item)]]">[[_getTag(item)]]</span>
                <a class="tag-deleter" data-args="[[_getItemValue(item)]]"
                   href="javascript:void(0);"
                   title="删除选项" on-click="_deleteTag">x</a>
            </span>
          </template>
          <input id="keywordInput"
                 value="{{ userInputKeyword::input }}"
                 autocomplete="off">
        </div> <!-- class=tags-input -->

        <div class="mask"></div>
      </div>

      <div id="picker-collapse" hidden>
        <table class="collapse-content__table">
          <thead>
          <tr>
            <template is="dom-repeat" items="[[displayFields]]">
              <th class="collapse-table__cell">[[item.label]]</th>
            </template>
            <th class="collapse-table__cell table-hotkey">快捷键</th>
          </tr>
          </thead>
          <tbody>
          <template is="dom-repeat" items="[[displayItems]]" as="row">
            <tr id="candidate-item__[[index]]" on-click="_selectCollapseItem">
              <template is="dom-repeat" items="[[displayFields]]" as="col">
                <td class="collapse-table__cell">[[_getCellValue(row,col)]]</td>
              </template>
              <td class="collapse-table__cell table-hotkey">[[_getHotKey(index)]]</td>
            </tr>
          </template>
          </tbody>
        </table>
      </div>
    </div>
  </template>
  <script>
    /**
     * `h2-picker`
     *
     * @customElement
     * @polymer
     * @demo demo/h2-picker/index.html
     */
    class H2Picker extends Polymer.Element {
      static get properties() {
        return {
          /**
           * 中文转拼音插件
           */
          pinyinUtil: {
            type: Object,
            readOnly: true,
            value: function () {
              return new PinyinUtil();
            }
          },
          /**
           * 缓存搜索插件
           */
          cacheSearchUtil: {
            type: Object,
            readOnly: true,
            value: function () {
              return new CacheSearchUtil();
            }
          },
          /**
           * 发送请求和模拟数据的组件
           */
          fetchUtil: {
            type: Object,
            readOnly: true,
            value: new H2Fetch()
          },
          /**
           * 标签
           */
          label: {
            type: String
          },
          /**
           * （接口查询模式）组件默认value值时，初始数据集的查询url
           * 注意：当此字段有值的时候，将启用接口查询模式，通过接口查询组件的数据集。items，searchFields，usePinyinSearch(本地查询模式)配置字段的将失效，无需配置
           */
          itemsInitQueryUrl: {
            type: String
          },
          /**
           * （接口查询模式）组件初始数据集查询参数,跟组件初始数据集查询url搭配使用
           */
          itemsQueryParams: {
            type: Object
          },
          /**
           * A url to fetch local data
           * @type {string}
           */
          src: {
            type: String
          },
          /**
           * A url to search data with user input keywords.
           * @type {string}
           */
          keywordSearchSrc: {
            type: String
          },
          /**
           * （本地查询模式）组件初始数据集
           * 如：[{"id": 1, "label": "快塑网", "business": "塑料"},{"id": 2, "label": "阿里巴巴", "business": "电商"}]
           */
          items: {
            type: Array
          },
          /**
           * 下拉面板当前展示的数据集（默认显示items的前10条）
           */
          displayItems: {
            type: Array
          },
          /**
           * 用户输入的模糊搜索关键字
           */
          userInputKeyword: {
            type: String
          },
          /**
           * （本地查询模式）模糊搜索的字段字符串数组，无值时，默认将所有字段做成搜索缓存
           */
          searchFields: {
            type: Array
          },
          /**
           * 下拉面板中展示的字段，默认为[{"field": "label", "label": "选项"}]
           */
          displayFields: {
            type: Array,
            value: [{"field": "label", "label": "选项"}]
          },
          /**
           * 已选数据项标签展示字段,默认为"label"
           */
          attrForLabel: {
            type: String,
            value: "label"
          },
          /**
           * 取值字段,默认为"value"
           */
          attrForValue: {
            type: String,
            value: "value"
          },
          /**
           * （本地查询模式）是否启用拼音搜索（根据模糊搜索的字段字符串数组对数据集的对应字段做中文转拼音处理），默认启用
           */
          usePinyinSearch: {
            type: Boolean,
            value: true
          },
          
          selectedValues: {
            type: Array,
            notify: true
          },
          /**
           *
           * 初始选择项和items的value值相对应
           *
           * @attribute value
           * @type {String}
           */
          value: {
            type: String,
            notify: true
          },
          /**
           * 是否只读
           */
          readonly: {
            type: Boolean,
            value: false
          },
          /**
           * 是否必填
           */
          required: {
            type: Boolean,
            value: false
          },
          /**
           * 是否支持多选
           */
          multi: {
            type: Boolean,
            value: false
          },
          /**
           * 下拉面板当前选项焦点
           */
          __focusIndex: {
            type: Number,
            value: 0
          }
        };
      }

      static get is() {
        return "h2-picker";
      }

      static get observers() {
        return [
          '_srcChanged(src)',
          '_itemsChange(items)',
          '_userInputKeywordChange(userInputKeyword)',
          '_selectedValuesChanged(selectedValues.splices)',
          '_valueChange(value)'
        ]
      }

      connectedCallback() {
        super.connectedCallback();

        this.$.keywordInput.addEventListener("keydown", this._keyDownHandler.bind(this));

        this.addEventListener("blur", e => {
          this.displayCollapse(false);
        });
      }

      _srcChanged(src) {
        if (!src) return;

        const request = new Request(src, {
          method: "GET",
          credentials: "include"
        });

        this.fetchUtil.fetchIt(request)
          .then(res => res.json())
          .then(data => {
            this.items = data || [];
          })
          .catch(err => console.error(err));
      }

      _itemsChange(items = []) {

        this.set('displayItems', items.slice(0, 9));

        // 初始化一次选中项
        this._valueChange(this.value);

        // 清空缓存插件的缓存
        this.cacheSearchUtil.resetCache();

        items.forEach(item => this.cacheSearchUtil.addCacheItem(item, this._loadPinyinKeys(item, this.searchFields)));
      }

      /**
       * 给对象根据searchFields给对应的字段做拼音缓存（字段值，字段值全拼和拼音首字母）
       */
      _loadPinyinKeys(item, searchFields = []) {
        let keys = [], values = searchFields.map(sf => item[sf]);

        values = values.length === 0 ? Object.values(item) : values;

        if (this.usePinyinSearch) {
          values.forEach(
            value => {
              keys = keys.concat(
                String(value),
                this.pinyinUtil.convert2CompletePinyin(value),
                this.pinyinUtil.convert2PinyinAbbreviation(value)
              );
            }
          );
        } else {
          keys = values.map(value => String(value));
        }

        return keys;
      }

      _userInputKeywordChange(userInputKeyword) {

        const matched = this.cacheSearchUtil.search(userInputKeyword);

        if (matched.length === 0 && this.keywordSearchSrc) {
          // 装载查询参数
          const queryParams = Object.assign({}, this.itemsQueryParams, {keyword: userInputKeyword});

          this._queryItems(
            this.keywordSearchSrc,
            queryParams,
            data => {
              // TODO data.rows ？？？
              this.set('displayItems', (data.rows || data || []).slice(0, 9));
              this._switchFocusItemAt(0);
            }
          );
        } else {
          this.set('displayItems', matched.slice(0, 9));
          this._switchFocusItemAt(0);
        }
      }


      _selectedValuesChanged() {
        this.value = this.selectedValues.map(selected => selected[this.attrForValue]).join(',');
      }

      /**
       * value属性变化监听函数
       */
      _valueChange(value) {
        // 本地模式，或远程数据已经就位
        if (this.displayItems) {
          const flatValues = [...(new Set(String(value).split(",")))];
          const selectedValues = this.selectedValues || [];
          const dirty = selectedValues.map(selected => selected[this.attrForValue]).join(',');
          if (dirty !== value) {
            const tmp = [...selectedValues, ...this.displayItems];
            this.selectedValues =
              flatValues.map(val => tmp.find(item => item[this.attrForValue] == val))
                .filter(selected => !!selected);
          }
        }
      }

      _queryItems(url, queryParams, successCallback) {
        const reqUrl = new URL(url, window.location.href);

        Object.keys(queryParams).filter(key => queryParams[key] != undefined)
          .forEach((key) => reqUrl.searchParams.append(key, queryParams[key]));

        const request = new Request(reqUrl, {
          method: "GET",
          credentials: "include"
        });

        this.fetchUtil.fetchIt(request)
          .then(res => res.json())
          .then(successCallback)
          .catch(err => console.error(err));
      }

      /**
       * 输入框键盘按键事件
       * @param event
       * @private
       */
      _keyDownHandler(event) {
        /**
         * 面板关闭的时候不允许选择数据
         */
        if (this._isPickerCollapseHidden()) {
          return;
        }

        if (event.altKey) {
          event.preventDefault();
        }

        const key = document.all ? event.keyCode : event.which;

        if (event.ctrlKey == 1 && key == 86) {// 复制操作，不处理
          return;
        }

        if (key == 38 || key == 40 || key == 32 || event.altKey) {
          event.stopPropagation();
        }

        if (key == 38) {// 按键UP
          this._switchFocusItemAt(this.__focusIndex - 1);
        } else if (key == 40) {// 按键DOWN
          this._switchFocusItemAt(this.__focusIndex + 1);
        } else if (key == 32 || key == 13) {// 空格、回车
          event.preventDefault();
          if (this.displayItems.length > 0 && this.__focusIndex < this.displayItems.length) {
            this.selectItemAt();
          }
        } else if (event.altKey) {
          let ind = String.fromCharCode(key) - 1;
          if (ind >= 0 && ind < this.displayItems.length) {
            this.selectItemAt(ind);
          }
        }
      }

      selectItemAt(index) {
        if (index >= 0) {
          this._switchFocusItemAt(index);
        }
        this.selectItem(this.displayItems[this.__focusIndex]);
      }

      /**
       * 选择选项
       * @param item
       */
      selectItem(item) {
        // not yet selected
        if (!~this.selectedValues.findIndex(selected => selected[this.attrForValue] == item[this.attrForValue])) {
          if (this.multi) {
            this.push('selectedValues', item);
          } else {
            this.selectedValues = [item];
          }
        }

        this.userInputKeyword = "";
      }

      /**
       * 切换焦点到第n个元素，从0开始
       * @param index
       * @private
       */
      _switchFocusItemAt(index) {
        setTimeout(() => {
          const maxIndex = (this.displayItems || []).length;
          const newIndex = (maxIndex + index) % maxIndex;
          this.root.querySelectorAll("tr.candidate-item--focus")
            .forEach(e => e.classList.remove('candidate-item--focus'));

          const newFocusItem = this.root.querySelector(`#candidate-item__${newIndex}`);
          if (newFocusItem != null) {
            newFocusItem.classList.add('candidate-item--focus');
            this.__focusIndex = newIndex;
          }
        }, 0);
      }

      _isPickerCollapseHidden() {
        return this.$["picker-collapse"].hidden;
      }

      __openCollapse({target: {classList}}) {

        if (classList.contains('tag-deleter')) {
          return;
        }

        this.displayCollapse(true);
        this.__focusOnKeywordInput();
        this._switchFocusItemAt(0);
      }

      __focusOnKeywordInput() {
        this.$.keywordInput.focus();
      }

      displayCollapse(display) {
        this.$["picker-collapse"].hidden = !display;
      }

      toggleCollapse() {
        const hidden = this.$["picker-collapse"].hidden;
        this.$["picker-collapse"].hidden = !hidden;
        this.__focusOnKeywordInput();
      }

      _selectCollapseItem(event) {
        event.stopPropagation();
        this.selectItem(event.model.row);
        this.__focusOnKeywordInput();
      }

      /**
       * 删除Tag项，事件处理函数
       */
      _deleteTag(e) {
        let value = e.target.dataArgs;
        const ind = this.selectedValues.findIndex(selected => selected[this.attrForValue] == value);
        this.splice("selectedValues", ind, 1);
      }

      _getHotKey(index) {
        return 'Alt+' + (index + 1);
      }

      _getTag(item) {
        return item[this.attrForLabel];
      }

      _getItemValue(item) {
        return item[this.attrForValue];
      }

      /**
       * 获取列值
       * @param row 数据行
       * @param col 数据列属性
       * @private
       */
      _getCellValue(row, col) {
        return row[col.field];
      }

      /**
       * 输入框获取焦点
       */
      doFocus() {
        this.__focusOnKeywordInput();
      }

      validate() {
        return this.required ? this.value != undefined : true;
      }
    }

    window.customElements.define(H2Picker.is, H2Picker);
  </script>
</dom-module>
