<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="./h2-label.html">
<!--

```javascript

<h2-select></h2-select>
```
-->

<dom-module id="h2-select">
  <template>
    <style>
      :host {
        display: flex;
        width: 300px;
        height: 34px;
        line-height: 34px;
        position: relative;
      }

      h2-label {
        font-size: inherit;
        height: inherit;
        line-height: inherit;

        @apply --h2-select-label;
      }

      #select__container {
        flex: 1;
        display: flex;
        height: inherit;
        border: 1px solid #CCC;
        border-radius: 4px;
        position: relative;
      }

      .tags__container {
        flex: 1;
        position: relative;
        display: flex;
      }

      .select__container__viewer {
        flex: 1;
        display: flex;
        flex-wrap: nowrap;
      }

      #caret {
        height: inherit;
      }

      #tag-content {
        flex: 1;

        display: flex;
        flex-wrap: wrap;
        align-content: flex-start;
        overflow-y: auto;
        padding: 4px;
      }

      .tag {
        color: #666;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;

        margin: 2px 2px 3px 2px;
        padding: 0 4px;
        height: 22px;
        line-height: 22px;

        display: flex;
        max-width: 200px;

        font-size: 14px;
        white-space: nowrap;
        @apply --h2-select-tag;
      }

      .tag-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .tag a {
        margin-left: 6px;
        font-weight: bold;
        text-decoration: inherit;
      }

      .tag a:hover {
        color: #f60;
      }

      :host input {
        border: none;
        outline: medium;
        font-size: 13px;
        height: 24px;
        line-height: 24px;
        width: 1px;
        background-color: #ffffff;
      }

      #select-collapse {
        -webkit-transition: max-height 100ms ease-in;
        -moz-transition: max-height 100ms ease-in;
        -ms-transition: max-height 100ms ease-in;
        -o-transition: max-height 100ms ease-in;
        transition: max-height 100ms ease-in;

        max-height: 0;
        position: absolute;
        top: 100%;
        width: 100%;
        overflow-y: auto;
        z-index: 999;
        margin-top: 1px;

        font-size: 14px;
        text-align: left;
        background-color: #fff;
        -moz-border-radius: 4px;
        -webkit-border-radius: 4px;
        border-radius: 4px;
        -moz-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
        -webkit-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
        background-clip: padding-box;
        @apply --h2-select-dropdown;
      }

      #select-collapse[data-collapse-open] {
        max-height: 300px;
      }

      :host([readonly]) .mask,
      :host([disabled]) .mask {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.5);
        z-index: 102;
      }

      .selector-panel {
        /*max-height: 300px;*/
        /*overflow: auto;*/
        display: block;
        padding: 5px;
      }

      .candidate-item {
        text-align: left;
        padding: 0 8px;
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        height: 22px;
        line-height: 22px;
        cursor: pointer;
      }

      .candidate-item:not([class*='iron-selected']):hover {
        color: #0099FF;
      }

      .iron-selected {
        background-color: #0099FF;
        color: #fff;
      }

      .iron-selected:hover {
        opacity: 0.8;
      }

      :host #placeholder {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;

        opacity: 0.5;
        padding: 0 6px;
        overflow: hidden;
        white-space: nowrap;
      }
    </style>
    <h2-label value="[[label]]" required="[[required]]"></h2-label>
    <div id="select__container">
      <div class="select__container__viewer" on-click="_onInputClick">
        <div class="tags__container">
          <div id="placeholder">[[placeholder]]</div>
          <div id="tag-content">
            <template is="dom-repeat" items="{{selectedList}}">
              <div class="tag">
                <span class="tag-name" title="[[_getLabel(item)]]">[[_getLabel(item)]]</span>
                <a data-args="[[_getValue(item)]]" href="javascript:void(0);"
                   title="删除该选项" on-click="_deleteTag">x</a>
              </div>
            </template>
          </div>
          <iron-input id="input" slot="input" maxlength$="[[maxlength]]">
            <input id="tags-input"
                   on-keydown="_updatePressed"
                   readonly
                   autocomplete$="off">
          </iron-input>
        </div>
        <iron-icon id="caret" icon="icons:arrow-drop-down"></iron-icon>
      </div>

      <div id="select-collapse">
        <iron-selector class="selector-panel" multi="[[multi]]" selected-values="{{selectedList}}"
                       selected="{{selected}}" attr-for-selected="radio-item">
          <template is="dom-repeat" items="[[items]]">
            <div class="candidate-item" radio-item="[[item]]" title="[[_getLabel(item)]]">[[_getLabel(item)]]</div>
          </template>
        </iron-selector>
      </div>

      <div class="mask"></div>
    </div>

  </template>
  <script>
    /**
     * `h2-select`
     *
     * @customElement
     * @polymer
     * @demo demo/h2-select/index.html
     */
    class H2Select extends Polymer.Element {
      static get properties() {
        return {
          /**
           *
           * 标签名字
           *
           * @attribute label
           * @type {String}
           */
          label: {
            type: String
          },
          /**
           * 占位符
           * @type {String}
           */
          placeholder: {
            type: String
          },
          /**
           * 是否支持多选
           */
          multi: {
            type: Boolean,
            value: false
          },
          /**
           *
           * 初始选择项和items的value值相对应
           * eg：1
           *
           * @attribute selected
           * @type {String}
           */
          value: {
            type: String,
            reflectToAttribute: true,
            notify: true
          },
          /**
           *
           * 需要展示的数据项
           * eg：[{value:1,label:"全部",isShow:true/false}]
           *
           * @attribute items
           * @type {Array}
           */
          items: {
            type: Array,
            notify: true,
            value: []
          },
          /**
           * 被选中的数据项（单选时生效）
           */
          selected: {
            type: Object,
            notify: true
          },
          /**
           * 被选中的数据项集合（多选时生效）
           */
          selectedList: {
            type: Array,
            notify: true
          },
          /**
           * 是否必填
           */
          required: {
            type: Boolean,
            value: false
          },
          /**
           * 是否只读
           */
          readonly: {
            type: Boolean,
            value: false
          },
          maxlength: {
            type: Number
          },
          /**
           * 用来取值的字段，默认为value
           */
          attrForValue: {
            type: String,
            value: "value"
          },
          /**
           * 用来展示的字段，默认为label
           */
          attrForLabel: {
            type: String,
            value: "label"
          }
        };
      }

      static get is() {
        return "h2-select";
      }

      static get observers() {
        return [
          '_selectedChange(selected)',
          '_selectedListChange(selectedList.splices)',
          '_valueChange(value,items)'
        ];
      }

      connectedCallback() {
        super.connectedCallback();
        this.addEventListener('blur', e => {
          // make sure other event can happen on slotted element before the iron-collapse closed.
          console.log(e);
          // setTimeout(this.closeCollapse.bind(this), 100);
          console.log(document.activeElement);
        });
      }

      /**
       * 点击事件
       */
      _onInputClick(e) {
        e.stopPropagation();
        if (e.target.tagName === "A") {
          return;
        }

        this.$['tags-input'].focus();
        this.toggleCollapse();
      }

      /**
       * value,items属性变化监听函数
       */
      _valueChange(value, items) {
        //如果传过来的值为null或者为""(空串)，那么直接清除所有选项
        if (value == null || value === "") {
          this.set("selectedList", []);
          this.multi ? "" : this.set("selected", undefined);
          return;
        }

        if (items && items.length > 0) {
          this.$['placeholder'].style.display = 'none';
          let values = (value + "").split(",");
          let selectedList = items.filter(e => values.some(s => e[this.attrForValue] == s));
          this.set("selectedList", selectedList);

          //对外抛一个选定数据变化事件，提供给h2-mask组件取值
          this.dispatchEvent(new CustomEvent('h2-selected-list-changed', {
            composed: true,
            bubbles: true,
            detail: {value: selectedList}
          }));

          this.multi ? "" : this.set("selected", selectedList[0]);
        }
      }

      _selectedListChange(splices) {
        if (splices == undefined || splices.length === 0) {
          return;
        }
        this.closeCollapse();
        this.set("value", splices.indexSplices[0].object.map(e => this._getValue(e)).join(","));
      }

      _selectedChange(selected) {
        if (selected == undefined) {
          return;
        }
        this.set("value", this._getValue(selected));

        this.closeCollapse();
        const selectedList = [];
        selectedList.push(this.selected);
        this.dispatchEvent(new CustomEvent('h2-selected-list-changed', {
          composed: true,
          bubbles: true,
          detail: {value: selectedList}
        }));
      }

      /**
       * 删除Tag项，事件处理函数
       */
      _deleteTag(e) {
        let self = this;
        // this._collapseToggle("close");
        this.closeCollapse();
        let value = e.target.dataArgs;
        this.selectedList.forEach((item, i) => {
          if (item == null) {
            self.splice("selectedList", i, 1);
          } else if (this._getValue(item) == value) {
            self.splice("selectedList", i, 1);
          }
        });
      }

      /**
       * 快捷方式
       * @param event
       * @private
       */
      _updatePressed(event) {
        if (event.keyCode == 8 && this.selectedList) { //退格符8,不用手动控制退一个字符//存在数据才抛出,解决新增时候数据为空时退格Array.length出错问题
          this.pop("selectedList");
        }
      }


      openCollapse() {
        this.$["select-collapse"].setAttribute('data-collapse-open', '');
        this.$['caret'].icon = 'icons:arrow-drop-up';
      }

      closeCollapse() {
        this.$["select-collapse"].removeAttribute('data-collapse-open');
        this.$['caret'].icon = 'icons:arrow-drop-down';
      }

      toggleCollapse() {
        if(this.$["select-collapse"].hasAttribute('data-collapse-open')) {
          this.$["select-collapse"].removeAttribute('data-collapse-open');
        } else {
          this.$["select-collapse"].setAttribute('data-collapse-open', '');
        }
      }
      /**
       * 获取展示字段名
       */
      _getLabel(item) {
        return item[this.attrForLabel];
      }

      /**
       * 获取展示字段值
       */
      _getValue(item) {
        return item[this.attrForValue];
      }

      /**
       * 模拟点击一次输入框，触发展示下拉面板行为
       */
      doFocus() {
        this.root.querySelector("div.select__container__viewer").click();
      }

      /**
       * 校验
       * @returns {boolean}
       */
      validate() {
        return this.required ? this.value != undefined : true;
      }
    }

    window.customElements.define(H2Select.is, H2Select);
  </script>
</dom-module>
