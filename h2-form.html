<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="behaviors/base-behavior.html">
<link rel="import" href="behaviors/ajax-behavior.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="h2-fetch.html">

<!--

```javascript

<h2-form></h2-form>
```
-->

<dom-module id="h2-form">
    <template>
        <style>
            .container {
                display: grid;
                grid-column-gap: 10px;
                grid-row-gap: 10px;
                grid-template-columns: 45% 45%;
                justify-items: center;
                @apply (--form-container-style);
            }

            .btns {
                position: relative;
                padding: 8px 8px 8px 24px;
                margin: 0;
                display: flex;
                justify-content: flex-end;
            }
        </style>
        <h2>[[title]]</h2>

        <div class="container">
            <slot></slot>
        </div>
        <div class="btns">
            <template is="dom-if" if="[[ !hideSubmitBtn ]]">
                <paper-button raised on-click="submit">保存</paper-button>
            </template>
            <template is="dom-if" if="[[ !hideResetBtn ]]">
                <paper-button raised on-click="reset">重置</paper-button>
            </template>
        </div>
        <h2-fetch id="fetch" request="{{request}}" handle-response-as="{{handleResponseAs}}"
                  response-body="{{responseBody}}"></h2-fetch>
    </template>
    </div>
    </template>
    <script>
        /**
         * `h2-form`
         *
         * @customElement
         * @polymer
         * @demo demo/h2-form/index.html
         */
        class H2Form extends Polymer.mixinBehaviors([BaseBehavior, AjaxBehavior], Polymer.Element) {
            static get properties() {
                return {
                    /**
                     * this form title
                     */
                    title: {
                        type: String
                    },
                    /**
                     * hide submit button or not,default not
                     */
                    hideSubmitBtn: {
                        type: Boolean,
                        value: false
                    },
                    /**
                     * hide reset button or not,default not
                     */
                    hideResetBtn: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Request method,GRT or POST,default POST
                     */
                    method: {
                        type: String,
                        value: "POST"
                    },

                    /**
                     * User-defined submit function,instead of the default method
                     */
                    bindSubmit: {
                        type: Object
                    },
                    /**
                     * User-defined reset function,instead of the default method
                     */
                    bindReset: {
                        type: Object
                    },
                    /**
                     * This form require url
                     */
                    url: {
                        type: String
                    },
                    /**
                     * submit type
                     * default,json,formData selection is optional
                     */
                    submitType: {
                        type: String,
                        value: "default"
                    },
                    /**
                     * How to handle the response body, the handled result will access as the property 'responseBody'.
                     * json/text/blob/arrayBuffer
                     */
                    handleResponseAs: {
                        type: String,
                        value: "json"
                    },

                    /**
                     * Handled response body.
                     */
                    responseBody: {
                        type: Object,
                        notify: true
                    },
                };
            }

            static get is() {
                return "h2-form";
            }


            /**
             * default submit Function,
             */
            submit() {
                if (this.isFunction(this.bindSubmit)) {
                    setTimeout(() => this.bindSubmit(), 0);
                } else {
                    let params = {};
                    let requestInit = {};
                    for (let i = 0; i < this.childElementCount; i++) {
                        params[this.children[i].getAttribute("name")] = this.children[i].value || ""
                    }
                    delete params.null;

                    if (this.method == "GET") {
                        const reqUrl = new URL(window.location.origin + this.url);
                        Object.keys(params).filter(key => params[key] != undefined).forEach((key) => reqUrl.searchParams.append(key, params[key]));
                        requestInit = {
                            method: this.method,
                            credentials: "include",
                            cache: 'default'
                        };
                        this.set("request", new Request(reqUrl, requestInit));
                    } else if (this.method == "POST") {
                        let headers = {}, body = {};
                        if (this.submitType == "json") {
                            headers = {
                                'content-type': 'application/json;charset=utf-8'
                            };
                            body = JSON.stringify(params);
                        } else if (params instanceof FormData) {
                            body = params;
                        } else {
                            const searchParams = new URLSearchParams();
                            Object.keys(params).forEach((key) => searchParams.append(key, params[key]));
                            body = searchParams;
                        }
                        this.set("request", new Request(this.url, {
                            method: this.method,
                            credentials: "include",
                            headers: headers,
                            body: body
                        }));
                    }
                }

            }

            /**
             * Default reset Function,Sets all the child element value to " "
             */
            reset() {
                if (this.isFunction(this.bindReset)) {
                    setTimeout(() => this.bindReset(), 0);
                } else {
                    let params = {}
                    for (let i = 0; i < this.childElementCount; i++) {
                        this.children[i].value = ""
                    }
                }
            }
        }
        window.customElements.define(H2Form.is, H2Form);
    </script>
</dom-module>
